
{% load playerportal_extras %}

<div class="container" id="accordion">
	{% for lift_name, lifts in lift_data.items %}
		{% if lifts %}
			<div class="card">

				<div class="card-header text-center" id="{{ lift_name|id_format }}Heading">
						<button id="{{ lift_name|id_format }}Button" class="btn btn-link collapsed text-danger" data-toggle="collapse" data-target="#{{ lift_name|id_format }}Content" aria-expanded="true" aria-controls="{{ lift_name|id_format }}Content">
							<h3>{{ lift_name }} Progress</h3>
						</button>
				</div>

				
				<div id="{{ lift_name|id_format }}Content" class="collapse" aria-labelledby="{{ lift_name|id_format }}Heading" data-parent="#accordion">
					<div class="card-body">

						<ul class="nav nav-tabs justify-content-center" id="{{ lift_name|id_format }}-tab" role="tablist">
								
								<li class="nav-item" role="presentation">
								<a class="nav-link active" id="{{ lift_name|id_format }}-chart-tab" data-toggle="tab" href="#{{ lift_name|id_format }}-chart" role="tab" aria-controls="{{ lift_name|id_format }}-chart" aria-selected="true">Graph</a>
								</li>

								<li class="nav-item" role="presentation">
								<a class="nav-link" id="{{ lift_name|id_format }}-table-tab" data-toggle="tab" href="#{{ lift_name|id_format }}-table" role="tab" aria-controls="{{ lift_name|id_format }}-table" aria-selected="false">Table</a>
								</li>

						</ul>

						<br>

						<div class="tab-content" id="{{ lift_name|id_format }}-tabContent">

							<div class="tab-pane fade show active" id="{{ lift_name|id_format }}-chart" style="height: 50vh; width: 100%" role="tabpanel" aria-labelledby="{{ lift_name|id_format }}-chart-tab">
								<canvas id="{{ lift_name|id_format }}Chart"></canvas>
							</div>

							 <div class="container tab-pane fade" id="{{ lift_name|id_format }}-table" role="tabpanel" aria-labelledby="{{ lift_name|id_format }}-table-tab">
							  	<table class="table table-striped table-bordered">
									<thead class="thead-dark">
										<tr class="text-center">
											<th>Date</th>
											<th>Lift Sets</th>
											<th>Strength Points</th>
										</tr>
									</thead>
									<tbody>
										{% for lift in lifts %}
											<tr class="text-center">
												<td class="align-middle">
													{{ lift.date }}
												</td>
												<td class="align-middle">
													{{ lift.sets }}
												</td>
												<td class="align-middle">
													{{ lift.strength_points }} SP
												</td>
											</tr>
										{% endfor %}
										<tr class="text-success text-center">
											<td>
												<b>Improvement:</b>
											</td>
											<td></td>
											<td>
												<b>{{ lifts.last.strength_points|subtract:lifts.first.strength_points }} SP</b>
											</td>
										</tr>
									</tbody>
								</table>
							</div>

						</div>	
					</div>
				</div>
			</div>
		{% endif %}
	{% endfor %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

<script>
	async function getDataAndDates(metricName, dataType)
	{
		let result;

		try {
			result = await $.ajax({
				url: "{% url 'get_player_data_and_dates' %}",
				type: 'GET',
		        data: {
		          'data_type': dataType,
		          'player_id': "{{ player.player_id }}",
		          'metric_name': metricName
		        },
		        dataType: 'json',
			});

			return result;
		} catch (error) {
			console.error(error);
		}
	}

	async function generateChart(chartId, metricName, dataType, label)
	{
		if ($("#".concat(chartId).concat("Chart")).length)
		{
			const ajaxResponse = await getDataAndDates(metricName, dataType);

			const dates = ajaxResponse.dates;
			const data = ajaxResponse.data;

			var line_chart_options = {
				maintainAspectRatio: false,
	      		scales: {
	        		x: {
	        			type: 'time',
	        			distribution: 'linear',
	        			time: {
	        				parser: 'MM/DD/YYYY',
	        				unit: 'month'
	        			},
	        			bounds: 'labels'
	          		},
	          		yAxes: [{
	          			scaleLabel: {
	          				display: true,
	          				labelString: label
	          			}
	          		}]
	      		},
	      		legend: {
	      			display: false
	      		}
	    	}
	    	var line_chart_data = {
				labels: dates,
				datasets: [
					{
						label: label,
						backgroundColor: 'transparent',
						borderColor: 'rgb(199, 44, 58)',
						borderWidth: 2,
						pointBackgroundColor: 'rgb(199, 44, 58)',
						data: data,
						fill: false,
						lineTension: 0
					}
				]
			}

			var ctx = document.getElementById(chartId.concat("Chart")).getContext('2d');
			var chart = new Chart(ctx, {
						type: 'line',
						data: line_chart_data,
						options: line_chart_options
					});
		}
	}

	{% for lift_name in lift_data %}
		generateChart("{{ lift_name|id_format }}", "{{lift_name}}", "lift", "Strength Points");
	{% endfor %}
</script>