{% extends 'base.html' %}
{% load static %}
{% load teammanagement_tags %}
{% load playerprogress_tags %}

{% block title %}{{ player.info.full_name }}{% endblock %}
{% block description %}<meta name="description" content="{{ player.info.full_name }} extended roster details and player progress.">{% endblock %}

{% block stylesheet %}
	<link rel="stylesheet" href="{% static 'css/teammanagement.css' %}">
{% endblock %}

{% block content %}

	<div class="container pt-2">
		<hr>
	</div>

	<div id="playerInfo" class="container pt-2">
		<div class="row">
			<div class="col-md-3 text-center mb-3 pl-md-4 pl-lg-5">
				{% if player.roster_photo %}
					<img src="{{ player.roster_photo.url }}" width="175px" class="rounded border border-dark shadow-lg" alt="{{ player.info.full_name }} roster photo">
				{% endif %}
			</div>

			<div class="col-md-7 px-4 px-md-3 ml-md-4 ml-lg-2">
				<h1>
					<span class="text-danger px-2 pb-1" style="background-color: black; display: inline-block;">{{ player.number }}</span>
					<span style="font-size: smaller;">{{ player.info.full_name|upper }}</span>
				</h1>

				<hr>

				<div class="row">
					<div class="col-md-6">
						<p>
							<b>CLASS:</b> {{ player.info.graduation_year }}
						</p>
						<hr>
						<p>
							<b>POSITION:</b> {{ player.position }}
						</p>
						<hr>
						<p>
							<b>BATS/THROWS:</b> {{ player.info.bats }}/{{ player.info.throws }}
						</p>
						<hr>
					</div>
					<div class="col-md-6">
						<p>
							<b>HEIGHT:</b> {{ player.height }}
						</p>
						<hr>
							<p>
								<b>WEIGHT:</b> {{ player.weight }} lbs
							</p>
							<hr>
					</div>
				</div>
			</div>

		</div>
	</div>
	<br>

	<div id="playerProgress" style="display: none">
		<div class="text-center text-dark">
			<h3 class="text-muted">Player Progress</h3>
		</div>
		<div id="accordion" class="container"></div>
	</div>

{% endblock %}



{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
<script src="{% static 'js/teammanagement.js' %}"></script>

<script>
	generateAccordionTabs();

	function generateAccordionTabs() {
		var playerId = "{{ player.info.player_id }}";

		// Fetch All Data async and await together
		$.when(fetchBodyWeightDataAsync(playerId), fetchLiftingDataAsync(playerId), fetchVelocityDataAsync(playerId), fetchTimeDataAsync(playerId))
			.done(function(bodyWeightResponse, liftingResponse, velocityResponse, timeResponse) {

				// Then Generate each tab synchronously
				generateBodyWeightTab(playerId, bodyWeightResponse[0]);
				generateLiftingTab(playerId, liftingResponse[0]);
				generateVelocityTab(playerId, velocityResponse[0]);
				generateTimesTab(playerId, timeResponse[0]);

				displayProgressIfData();
			});
	}

	function displayProgressIfData() {
		if ($("#accordion").has(".card").length) {
			$("#playerProgress").fadeIn(250);
		}
	}

	function fetchBodyWeightDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-body-weights-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchLiftingDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-lifts-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchVelocityDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-velocities-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchTimeDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-times-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchDataWithDatesAsync(url, playerId)
	{
		return $.ajax({
			url: url,
			type: 'GET',
			data: {
				'player_id': playerId,
			},
			dataType: 'json',
		});
	}

	function generateBodyWeightTab(playerId, dataResponse) {
		var sectionData = GetBodyWeightSectionData();

		sectionData.dataToDisplay.bodyWeight.data = dataResponse.bodyWeight;
		sectionData.allDates = dataResponse.allDates;

		if (sectionData.allDates.length > 0) {
			createTabScaffolding(sectionData.idPrefix, sectionData.title, sectionData.graph.hasGraph);
			generateChart(sectionData);
			generateTables(sectionData);
		}
	}

	function generateLiftingTab(playerId, dataResponse) {
		var sectionData = getLiftSectionData();

		sectionData.dataToDisplay.deadlift.data = dataResponse.deadlift;
		sectionData.dataToDisplay.squat.data = dataResponse.squat;
		sectionData.dataToDisplay.benchPress.data = dataResponse.benchPress;
		sectionData.allDates = dataResponse.allDates;
		
		if (sectionData.allDates.length > 0) {
			createTabScaffolding(sectionData.idPrefix, sectionData.title, sectionData.graph.hasGraph);
			generateChart(sectionData);
			generateTables(sectionData);
		}
	}

	function generateVelocityTab(playerId, dataResponse) {
		var sectionData = getVelocitySectionData();

		sectionData.dataToDisplay.exit.data = dataResponse.exit;
		sectionData.dataToDisplay.pitching.data = dataResponse.pitching;
		sectionData.dataToDisplay.outfield.data = dataResponse.outfield;
		sectionData.dataToDisplay.infield.data = dataResponse.infield;
		sectionData.allDates = dataResponse.allDates;
		
		if (sectionData.allDates.length > 0) {
			createTabScaffolding(sectionData.idPrefix, sectionData.title, sectionData.graph.hasGraph);
			generateChart(sectionData);
			generateTables(sectionData);
		}
	}

	function generateTimesTab(playerId, dataResponse) {
		var sectionData = getTimeSectionData();

		sectionData.dataToDisplay.sixty.data = dataResponse.sixty;
		sectionData.allDates = dataResponse.allDates;

		if (sectionData.allDates.length > 0) {
			createTabScaffolding(sectionData.idPrefix, sectionData.title, sectionData.graph.hasGraph);
			generateTables(sectionData);
		}
	}

	function GetBodyWeightSectionData() {
		return {
			allDates: [],
			dataToDisplay: {
				bodyWeight: {
					chartColor: 'rgb(199, 44, 58)',
					data: [],
					idPrefix: "bodyWeightData",
					table: {
						tabTitle: "Table"
					},
					title: "Body Weight"
				}
			},
			graph: {
				hasGraph: true,
				timeUnit: 'week',
				title: "Body Weight (lbs)",
			},
			idPrefix: "bodyWeight",
			metricLabel: "lbs",
			table: {
				columns: ['Date', 'Body Weight (lbs)']
			},
			title: "Body Weight"
		}
	}

	function getLiftSectionData() {
		return {
			allDates: [],
			dataToDisplay: {
				deadlift: {
					chartColor: 'rgb(199, 44, 58)',
					data: [],
					idPrefix: "deadlift",
					table: {
						tabTitle: "Deadlift"
					},
					title: "Deadlift"
				},
				squat: {
					chartColor: 'black',
					data: [],
					idPrefix: "squat",
					table: {
						tabTitle: "Squat"
					},
					title: "Squat"
				},
				benchPress: {
					chartColor: 'Gold',
					data: [],
					idPrefix: "benchPress",
					table: {
						tabTitle: "Bench"
					},
					title: "Bench Press"
				}
			},
			graph: {
				hasGraph: true,
				timeUnit: 'day',
				title: "Lift Results in Strength Points (SP)",
			},
			idPrefix: "lifting",
			metricLabel: "SP",
			table: {
				columns: ['Date', 'Strength Points (SP)', 'Lift Sets']
			},
			title: "Lifting"
		}
	};

	function getVelocitySectionData() {
		return {
			allDates: [],
			dataToDisplay: {
				exit: {
					chartColor: 'rgb(199, 44, 58)',
					data: [],
					idPrefix: "exit",
					table: {
						tabTitle: "Exit"
					},
					title: "Exit"
				},
				pitching: {
					chartColor: 'black',
					data: [],
					idPrefix: "pitching",
					table: {
						tabTitle: "Pitching"
					},
					title: "Pitching"
				},
				outfield: {
					chartColor: 'Gold',
					data: [],
					idPrefix: "outfield",
					table: {
						tabTitle: "Outfield"
					},
					title: "Outfield"
				},
				infield: {
					chartColor: 'Purple',
					data: [],
					idPrefix: "infield",
					table: {
						tabTitle: "Infield"
					},
					title: "Infield",
				}
			},
			graph: {
				hasGraph: true,
				timeUnit: 'month',
				title: "Velocity (MPH)"
			},
			idPrefix: "velocity",
			metricLabel: "MPH",
			table: {
				columns: ['Date', 'Velocity (MPH)']
			},
			title: "Velocities"
		}
	}

	function getTimeSectionData() {
		return {
			allDates: [],
			dataToDisplay: {
				sixty: {
					chartColor: 'rgb(199, 44, 58)',
					data: [],
					idPrefix: "sixty",
					table: {
						tabTitle: "60-yd Dash"
					},
					title: "60-yd Dash"
				}
			},
			graph: {
				hasGraph: false,
				timeUnit: 'month',
				title: "Time (s)"
			},
			idPrefix: "time",
			metricLabel: "s",
			table: {
				columns: ['Date', 'Time']
			},
			title: "Times"
		}
	}

	function createTabScaffolding(idPrefix, accordionTabTitle, hasGraph)
	{
		var tabAppend = $(`
			<div id="${idPrefix}Data" class="card">

				<div id="${idPrefix}Heading" class="card-header text-center">
					<button id="${idPrefix}Button" class="btn btn-link collapsed text-danger" data-toggle="collapse" data-target="#${idPrefix}Content" aria-expanded="true" aria-controls="${idPrefix}Content">
						<h3>
							<span>
								${accordionTabTitle}
							</span>
							<span>
						    	<i class="text-dark fa fa-plus-square"></i>
						    </span>
						</h3>
					</button>
				</div>

				<div id="${idPrefix}Content" class="collapse" aria-labelledby="${idPrefix}Heading" data-parent="#accordion">
					<div id="${idPrefix}DataBody" class="card-body">

						<ul id="${idPrefix}Tabs" class="nav nav-tabs justify-content-center" role="tablist"></ul>
						<br>
						<div id="${idPrefix}TabContent" class="tab-content"></div>

					</div>
				</div>

			</div>
		`);

		if (hasGraph) {
			$(tabAppend).find(`#${idPrefix}Tabs`).append(
				`<li class="nav-item" role="presentation">
					<a id="${idPrefix}ChartTab" class="nav-link active" data-toggle="tab" href="#${idPrefix}ChartContainer" role="tab" aria-controls="${idPrefix}ChartContainer" aria-selected="true">Graph</a>
				</li>`
			);
			$(tabAppend).find(`#${idPrefix}TabContent`).append(
				`<div id="${idPrefix}ChartContainer" class="tab-pane fade show active" style="height: 50vh; width: 100%" role="tabpanel" aria-labelledby="${idPrefix}ChartTab">
					<canvas id="${idPrefix}Chart"></canvas>
				</div>`
			);
		}

		$("#accordion").append(tabAppend);
	}

	function getDatasetDataArray(data) {
		var dataForDataset = [];
		data.forEach(tuple => dataForDataset.push({x: tuple[0], y: tuple[1]}));

		return dataForDataset;
	}

	function getChartDatasets(dataToDisplay) {
		var datasets = [];
		for (const dataCategory in dataToDisplay) {
			if (dataToDisplay[dataCategory].data.length > 0) {
				var categoryDataset = {
					label: dataToDisplay[dataCategory].title,
					backgroundColor: dataToDisplay[dataCategory].chartColor,
					borderColor: dataToDisplay[dataCategory].chartColor,
					borderWidth: 2,
					pointBackgroundColor: dataToDisplay[dataCategory].chartColor,
					fill: false,
					lineTension: 0,
					data: getDatasetDataArray(dataToDisplay[dataCategory].data),
				};

				datasets.push(categoryDataset);
			}
		}

		return datasets;
	}

	function generateChart(sectionData) {
		if ($("#".concat(sectionData.idPrefix).concat("Chart")).length)
		{
			var line_chart_options = {
				legend: {
					display: true
				},
				maintainAspectRatio: false,
				plugins: {
					legend: {
						labels: {
							font: {
								size: 10
							}
						}
					},
					title: {
						color: 'black',
						display: true,
						font: {
							size: 15
						},
						text: sectionData.graph.title 
					},
					tooltip: {
						callbacks: {
							label: function(context) {
								var label = context.dataset.label || '';

								if (label) {
									label += ': ';
								}

								label += context.parsed.y + ' ' + sectionData.metricLabel;

								return label;
							}
						}
					}
				},
				scales: {
					x: {
						bounds: 'labels',
						type: 'time',
						time: {
							parser: 'MM-DD-YYYY',
							unit: sectionData.graph.timeUnit,
							displayFormats: {
								day: 'MM/DD/YY',
								week: 'MM/DD/YY'
							},
							tooltipFormat: "MM/DD/YY"
						},
						ticks: {
							autoSkip: true,
							font: {
								size: 11
							},
							//maxTicksLimit: 20,
							includeBounds: true
						}
					},
					y: {
						ticks: {
							font: {
								size: 10
							}
						}, 
						title: {
							display: false,
							text: sectionData.metricLabel,
							font: {
								size: 10
							}
						}
					}
				}
			}
			var line_chart_data = {
				labels: sectionData.allDates,
				datasets: getChartDatasets(sectionData.dataToDisplay)
			}

			var ctx = document.getElementById(sectionData.idPrefix.concat("Chart")).getContext('2d');
			var chart = new Chart(ctx, {
						type: 'line',
						data: line_chart_data,
						options: line_chart_options
					});
		}
	}

	function generateTables(sectionData) {
		var sectionTabs = $(`#${sectionData.idPrefix}Tabs`);
		var sectionTabContent = $(`#${sectionData.idPrefix}TabContent`);

		for (const dataCategory in sectionData.dataToDisplay) {
			let currentCategory = sectionData.dataToDisplay[dataCategory];
			
			if (currentCategory.data.length > 0) {
				var tabToAppend;
				var tabContentToAppend;
				if (sectionData.graph.hasGraph) {
					tabToAppend = $(`
						<li class="nav-item" role="presentation">
							<a id="${currentCategory.idPrefix}TableTab" class="nav-link" data-toggle="tab" href="#${currentCategory.idPrefix}TableContainer" role="tab" aria-controls="${currentCategory.idPrefix}TableContainer" aria-selected="false">
								${currentCategory.table.tabTitle}
							</a>
						</li>
					`);

					tabContentToAppend = $(`
						<div id="${currentCategory.idPrefix}TableContainer" class="container tab-pane fade" role="tabpanel" aria-labelledby="${currentCategory.idPrefix}TableTab">
							<table id="${currentCategory.idPrefix}Table" class="table table-striped table-bordered">
								<thead id="${currentCategory.idPrefix}TableHead" class="thead-dark">
									<tr id="${currentCategory.idPrefix}TableHeadRow" class="text-center"></tr>
								</thead>
								<tbody id="${currentCategory.idPrefix}TableBody"></tbody>
							</table>
						</div>
					`);
				}
				else {
					tabToAppend = $(`
						<li class="nav-item" role="presentation">
							<a id="${currentCategory.idPrefix}TableTab" class="nav-link active" data-toggle="tab" href="#${currentCategory.idPrefix}TableContainer" role="tab" aria-controls="${currentCategory.idPrefix}TableContainer" aria-selected="true">
								${currentCategory.table.tabTitle}
							</a>
						</li>
					`);

					tabContentToAppend = $(`
						<div id="${currentCategory.idPrefix}TableContainer" class="container tab-pane fade show active" role="tabpanel" aria-labelledby="${currentCategory.idPrefix}TableTab">
							<table id="${currentCategory.idPrefix}Table" class="table table-striped table-bordered">
								<thead id="${currentCategory.idPrefix}TableHead" class="thead-dark">
									<tr id="${currentCategory.idPrefix}TableHeadRow" class="text-center"></tr>
								</thead>
								<tbody id="${currentCategory.idPrefix}TableBody"></tbody>
							</table>
						</div>
					`);
				}

				for (const columnName of sectionData.table.columns) {
					$(tabContentToAppend).find(`#${currentCategory.idPrefix}TableHeadRow`).append(`
						<th>${columnName}</th>
					`);
				} 

				for (const tuple of currentCategory.data) {
					let currentRow = $(`<tr class="text-center"></tr>`)
					for (const value of tuple) {
						$(currentRow).append(`
							<td class="align-middle">
								${value}
							</td>
						`);
					}

					$(tabContentToAppend).find(`#${currentCategory.idPrefix}TableBody`).append(currentRow);
				}

				$(sectionTabs).append(tabToAppend);
				$(sectionTabContent).append(tabContentToAppend);
			}
		}
	}	
</script>
{% endblock %}