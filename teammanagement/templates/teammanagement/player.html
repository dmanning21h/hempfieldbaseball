{% extends 'base.html' %}
{% load static %}
{% load teammanagement_tags %}
{% load playerprogress_tags %}

{% block title %}{{ player.info.full_name }}{% endblock %}
{% block description %}<meta name="description" content="{{ player.info.full_name }} extended roster details and player progress.">{% endblock %}

{% block stylesheet %}
	<link rel="stylesheet" href="{% static 'css/teammanagement.css' %}">
{% endblock %}

{% block content %}
	<div class="container pt-2">
		<hr>
	</div>

	<div id="playerInfo" class="container pt-2">
		<div class="row">
			<div class="col-md-3 text-center mb-3 pl-md-4 pl-lg-5">
				{% if player.roster_photo %}
					<img src="{{ player.roster_photo.url }}" width="175px" class="rounded border border-dark shadow-lg" alt="{{ player.info.full_name }} roster photo">
				{% endif %}
			</div>

			<div class="col-md-7 px-4 px-md-3 ml-md-4 ml-lg-2">
				<h1>
					<span class="text-danger px-2 pb-1" style="background-color: black; display: inline-block;">{{ player.number }}</span>
					<span class="text-shadow-sm" style="font-size: smaller;">{{ player.info.full_name|upper }}</span>
				</h1>

				<hr>

				<div class="row">
					<div class="col-md-6">
						<p>
							<b>CLASS:</b> {{ player.info.graduation_year }}
						</p>
						<hr>
						<p>
							<b>POSITION:</b> {{ player.position }}
						</p>
						<hr>
						<p>
							<b>BATS/THROWS:</b> {{ player.info.bats }}/{{ player.info.throws }}
						</p>
						<hr>
					</div>
					<div class="col-md-6">
						<p>
							<b>HEIGHT:</b> {{ player.height }}
						</p>
						<hr>
							<p>
								<b>WEIGHT:</b> {{ player.weight }} lbs
							</p>
							<hr>
					</div>
				</div>
			</div>

		</div>
	</div>
	<br>

	<div id="playerProgress" style="display: none">
		<div class="text-center text-muted text-shadow-sm">
			<h3 class="">Player Progress</h3>
		</div>
		<div id="accordion" class="container"></div>
	</div>

{% endblock %}



{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
<script src="{% static 'js/teammanagement.js' %}"></script>

<script>
	generateAccordionTabs();

	function generateAccordionTabs() {
		var playerId = "{{ player.info.player_id }}";

		// Fetch All Data async and await together
		$.when(fetchBodyWeightDataAsync(playerId), fetchLiftingDataAsync(playerId), fetchVelocityDataAsync(playerId), fetchTimeDataAsync(playerId))
			.done(function(bodyWeightResponse, liftingResponse, velocityResponse, timeResponse) {

			// Then Generate each tab synchronously
			generateBodyWeightTab(playerId, bodyWeightResponse[0]);
			generateLiftingTab(playerId, liftingResponse[0]);
			generateVelocityTab(playerId, velocityResponse[0]);
			generateTimesTab(playerId, timeResponse[0]);

			displayProgressIfData();
			});
	}

	function displayProgressIfData() {
		if ($("#accordion").has(".accordion-item").length) {
			$("#playerProgress").fadeIn(100);
		}
	}

	function fetchBodyWeightDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-body-weights-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchLiftingDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-lifts-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchVelocityDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-velocities-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}

	function fetchTimeDataAsync(playerId) {
		url = "{% url 'playerprogress:get-player-times-with-dates' %}";
		return fetchDataWithDatesAsync(url, playerId);
	}	
</script>
{% endblock %}